<?xml version='1.0'  encoding='UTF-8' ?>
<history>
	<historyItem>
		<sql><![CDATA[with find_zone_code as (
   select zone_code from (
       select zone_code from ca_allowed_cp
       union all
       select sclv.zone_code
       from ca_user_role_permission curp
               inner join safe_cp_location_view sclv on curp.reference_code = sclv.site_code
       where curp.reference_type = 'SE'
    ) group by zone_code
)
select
               pi.aCode,
               pi.adescription,
               pi.adescription2,
               pi.title,
               pi.forename,
               pi.surname,
               pi.assembly_point_code,
               pi.department,
               pi.zone_description location,
               pi.email,
               pi.ldap,
               pi.knownas,
               pi.hasphoto,
               pi.notification_email_ind,
               pi.notification_sms_ind,
               greatest(
--               utl_match.jaro_winkler_similarity(trim(pi.forename_lower || pi.surname_lower), trim(:q || nvl(:other_names, '%'))) score
                utl_match.jaro_winkler_similarity(trim(pi.forename_lower), trim(:q)),
                utl_match.jaro_winkler_similarity(trim(pi.surname_lower), trim(:other_names))) score
         from
             ca_active_host_location_person pi
         where
            ((pi.person_type in(
               select surrpt.reference_code
               from ca_user_role_permission surrpt
               where surrpt.reference_type = 'PNTP'
                 and surrpt.user_role_name = safe_get_user_role(:Uidtoken)
            )
               and pi.zone_code in
                   (
                      select fzc.zone_code
                      from find_zone_code fzc
                   )
               and pi.department_code in
                   (
                      select surrd.reference_code
                      from ca_user_role_permission surrd
                      where surrd.reference_type = 'DT'
                        and surrd.user_role_name = safe_get_user_role(:Uidtoken)
                   )
               and safe_get_setting_or_null('qr_host_permission_check') = 'Y') or safe_get_setting_or_null('qr_host_permission_check') = 'N')
               and (
                        contains(pi.forename_lower, 'fuzzy('|| :q ||', 80), 1') > 0
                     or contains(pi.surname_lower, 'fuzzy('|| nvl(:other_names, '%') ||', 80), 1') > 0
                  )
                  order by
   score desc]]></sql>
		<connection><![CDATA[Dev]]></connection>
		<timestamp><![CDATA[1716814743567]]></timestamp>
		<type><![CDATA[SQL]]></type>
		<executed><![CDATA[1]]></executed>
		<execTime><![CDATA[0.134]]></execTime>
	</historyItem>
</history>
