<?xml version='1.0'  encoding='UTF-8' ?>
<history>
	<historyItem>
		<sql><![CDATA[with allowed_cp as (
   select cp.collection_point_code, cp.collection_point_description, cp.check_id_ind, z.zone_code, z.zone_description, s.site_code,s.site_description, cp.timezone from 
   (
      select distinct cpp.* from ca_collection_point cpp 
         join safe_cluster_cp_view cl 
            on cl.collection_point_code= cpp.collection_point_code
            and cl.cluster_name = nvl(trim(:cl), cl.cluster_name)
   ) cp right outer join ca_zone z 
      on cp.zone_code = z.zone_code 
      and cp.collection_point_code = nvl(trim(:cp), cp.collection_point_code)
      and z.zone_code = nvl(trim(:b), z.zone_code)   
   join ca_site s 
      on s.site_code = z.site_code 
      and s.site_code = nvl(trim(:l), s.site_code) 
   join ca_user_role_permission surr
      on surr.reference_type = 'CNPT'
      and cp.collection_point_code = surr.reference_code
      and surr.user_role_name in 
      (
         select user_role_name 
         from  safe_user_role_assignment 
         where username = lower(:Uidtoken)
      )
),
ca_booked_person_filter as (
   select cbp.*,skw.visitor_type_description, skw.unnamed_visitors_label_code, to_char(skw.visitor_type_workflow) visitor_type_workflow
   from ca_booked_person cbp
   join safe_kiosk_workflow skw on cbp.visitor_type_code = skw.visitor_type_code
   where cbp.due_date_time >= to_date(:f, 'YYYY-MM-DD"T"HH24:MI:SS"Z"')
   and cbp.due_date_time <= to_date(:t, 'YYYY-MM-DD"T"HH24:MI:SS"Z"')
   and cbp.checked_out_date_time is null
   and cbp.cancellation_date_time is null
   and ((trim(:shv) = 'Y' and cbp.checked_in_date_time is not null) or (trim(:shv) is null) or (trim(:shv) = 'N' and cbp.checked_in_date_time is null))
   and (trim(:asset) is null or trim(:asset) = ca_visitor_assets_pak.visitor_has_assets(cbp.booking_reference))
   and cbp.visitor_type_code = nvl(trim(:vt),cbp.visitor_type_code)
),
ca_alternative_hosts_data as (
   select max(ca.booking_reference) booking_reference,
   to_char(substr(tab_to_clob(cast(collect(substr(ca.email_address, 0, instr(ca.email_address, '@') - 1 )) as t_varchar2_tab), ', '),1,3900)) cchost_username,
   to_char(substr(tab_to_clob(cast(collect(ca.known_as) as t_varchar2_tab), ', '),1,3900)) cchost_known_as,
   to_char(substr(tab_to_clob(cast(collect(ca.title_description || '$/' || ca.forename || '$/' || ca.surname || '$/' || ca.host_person_code || '$/' || ca.person_type_description || '$/' || ca.department_description || '$/' || ca.email_address || '$/' || ca.phone_number || '$/' || ca.known_as) as t_varchar2_tab), ']['),1,3900)) alt_hosts
   from ca_alternative_hosts_mv ca
      join ca_booked_person_filter cbpf on ca.booking_reference = cbpf.booking_reference
   group by ca.booking_reference
),
access_groups as (
   select listagg(cag.access_group_description, ', ') within group (order by cag.access_group_description) as accessgroupcombo, cpap.person_type, cpap.person_code
   from ca_access_group cag
      inner join ca_person_access_profile cpap
         on cpap.access_group_code = cag.access_group_code
   where cpap.expiry_date_time is null
      or cpap.expiry_date_time > sysdate
   group by (cpap.person_type, cpap.person_code)
   order by cpap.person_type, cpap.person_code
)
select distinct 
   paged.*
from
(  select
      aq2t.booking_reference,
      aq2t.email_address,
      aq2t.unnamed_visitors,
      aq2t.unnamed_visitors_label_code,
      decode(cpi.person_code, null, 'N', 'Y') mutated,
      cpi.person_code person_code,
      cpi.person_type person_type,
      aq2t.valid_badge_number,
      aq2t.issue_number badge_issue_number,
      cps.site_status_ind site_status_ind,
      public_reference,
      aq2t.group_id,
      ca_utility_pak.date_to_iso_zulu_string(due_date_time) due_date_time,
      ca_utility_pak.date_to_iso_zulu_string(end_date_time) end_date_time,
      ca_utility_pak.date_to_iso_zulu_string(due_date_time_utc_estimate) due_date_time_utc_estimate,
      aq2t.title,
      aq2t.title_code,
      aq2t.forename,
      aq2t.surname,
      aq2t.middle_name,
      ca_utility_pak.date_to_iso_zulu_string(aq2t.date_of_birth) date_of_birth,
      aq2t.default_visitor_label,
      aq2t.visit_reason_code,
      aq2t.visit_reason_description,
      ca_utility_pak.date_to_iso_zulu_string(checked_in_date_time) checked_in_date_time,
      leader_ind,
      aq2t.site_code,
      nvl2(nda_accepted_date_time,'Y','N')  nda_accepted_ind,
      ca_utility_pak.date_to_iso_zulu_string(aq2t.printed_date_time) printed_date_time,
      ca_utility_pak.date_to_iso_zulu_string(aq2t.virtual_badge_sent_date_time) virtual_badge_sent_date_time,
      aq2t.collection_point_code,
      aq2t.arrived_collection_point,
      aq2t.checked_in_source,
      aq2t.checked_in_source_description,
      ca_utility_pak.date_to_iso_zulu_string(id_check_date_time) id_check_date_time,
      collection_point_description,
      arrived_cp_description,
      check_id_ind,
      collected_by,
      hostTitle,
      hostForename,
      hostSurname,
      knownAs,
      aq2t.allowed_vip_ind,
      hostUsername,
      host,
      hostType,
      hostCode,
      hostCodeType,
      aq2t.hr_code,
      d_visitor.department_description department,
      d_visitor.department_code department_code,
      aq2t.zone_description zone,
      aq2t.zone_code,
      caup.date_to_iso_zulu_string(aq2t.active_date_time) active_date_time,
      caup.date_to_iso_zulu_string(aq2t.expiry_date_time) expiry_date_time,
      hostEmail,
      hostMobile,
      decode(aq2t.mobile_phone_number,null,aq2t.mobile_phone_number,'+' || aq2t.mobile_phone_number) mobile,
      aq2t.meal_code, 
      aq2t.meal_description meal,
      aq2t.country_code,
      aq2t.country_name country,
      aq2t.language_code,
      aq2t.language_description language,
      aq2t.communication_language_code,
      aq2t.communication_language_description communication_language,
      aq2t.nationality_code,
      aq2t.nationality_description nationality,
      aq2t.vehicle_reg,
      group_info,
      aq2t.comments,
      aq2t.company_code,
      companyName,
      hostTitleDesc,
      :s begin,
      :lim end,
      aq2t.total,
      aq2t.time_zone_description,
      aq2t.event_id,
      aq2t.event_description,
      aq2t.event_start_date,
      aq2t.event_end_date,
      aq2t.capacity,
      aq2t.capacity_criteria,
      aq2t.conf_text_1,
      aq2t.conf_combo_1,
      aq2t.conf_text_2,
      aq2t.conf_combo_2,
      aq2t.conf_text_3,
      aq2t.conf_combo_3,
      aq2t.conf_text_4,
      aq2t.conf_combo_4,
      aq2t.conf_text_5,
      aq2t.conf_combo_5,
      aq2t.conf_text_6 shift_id,
      aq2t.shared_qr_cc_hosts,
      aq2t.watchlist_ind,
      aq2t.watchlist_approver,
      ag.accessgroupcombo,
      aq2t.alt_hosts,
      aq2t.cchost_username,
      aq2t.cchost_known_as,
      ca_utility_pak.date_to_iso_zulu_string(aq2t.arrive_date_time) arrive_date_time,
      aq2t.reception_accept_ind,
      ca_utility_pak.date_to_iso_zulu_string(aq2t.collected_date_time) collected_date_time,
      aq2t.booker,
      ca_booked_person_get('host', 'all', aq2t.booking_reference ) host_data,
      ca_booked_person_get('booker', 'all', aq2t.booking_reference ) booker_data,
      ca_booked_person_get('collector', 'name', aq2t.booking_reference ) collector,
      ca_booked_person_get('collector', 'all', aq2t.booking_reference ) collector_data,
      aq2t.collecting_badge_number,
      ca_visitor_assets_pak.visitor_has_assets(aq2t.booking_reference) assets_ind,
      aq2t.vip,
      aq2t.agenda,
      aq2t.visitor_badge_number,
      aq2t.visitor_type_code,
      aq2t.visitor_type_description,
      aq2t.haspicture,
      aq2t.hassignature,
      (select case count(*) when 0 then 'N' else 'Y' end as visitor_uploaded_doc from ca_person_document where booking_reference = aq2t.booking_reference) as visitor_uploaded_doc,
      (select listagg(cdc.document_category_desc, ', ') within group (order by document_category_desc asc) from ca_person_document cpd left join ca_document_category cdc on cdc.document_category_code = cpd.document_category_code where cpd.booking_reference = aq2t.booking_reference) as document_data,
      aq2t.vetting_ind,
      aq2t.vetting_reviewed_date_time,
      aq2t.cc_host_person_code_type,
      (select case when count(bpch.checked_in_date_time) > 0 then 'Y' else 'N' end as someone_from_group_already_checked_in from ca_booked_person bpch where bpch.group_id = aq2t.group_id) someone_from_group_already_checked_in,
      aq2t.notif_ind_email_host,
      aq2t.notif_ind_email_cchosts,
      aq2t.notif_ind_email_visitor,
      aq2t.notif_ind_sms_host,
      aq2t.notif_ind_sms_cchosts,
      aq2t.notif_ind_sms_visitor,
      aq2t.car_parking_booking_id,
      aq2t.nda_signature_bypass_username,
      aq2t.id_verification_status,
      aq2t.visitor_type_workflow,
      aq2t.showScannerPanel
   from  
   (  select aq2.* 
      from
      (  select iq.*, rownum rnum, count(*) over () total
         from
         (  select
               b.booking_reference,
               b.unnamed_visitors,
               b.unnamed_visitors_label_code,
               b.email_address,
               case when safe_get_setting_or_null('enable_visitor_badge_manager') = 'Y' then cvb.badge_number else case when safe_get_setting_or_null('rfid_no_access') = 'Y' then to_char(b.access_badge_number) else to_char(cb.badge_number) end end as valid_badge_number,
               cb.active_date_time,
               cb.expiry_date_time,
               cb.issue_number,
               safe_get_encoded_reference(b.booking_reference) public_reference,
               b.group_id,
               b.due_date_time,
               b.end_date_time,
               svms_pak.zulu_date_to_ss_utc_estimate(b.due_date_time, b.collection_point_code) due_date_time_utc_estimate,
               svms_pak.zulu_date_to_ss_utc_estimate(b.end_date_time, b.collection_point_code) end_date_time_utc_estimate,
               ca_utility_pak.get_row_value_or_null('safe_person_title', 'title_description', 'title_code', b.title) title,
               b.title title_code,
               b.mobile_phone_number mobile_phone_number,
               b.meal_code,
               sm.meal_description meal_description,      
               b.country_code,
               sc.country_name country_name,
               b.language_code,
               b.communication_language_code,
               cl.language_description language_description,
               skl.language_description communication_language_description,
               b.vehicle_reg,
               b.nationality_code,
               cn.nationality_description nationality_description,
               b.forename,
               b.surname,
               b.middle_name,
               b.date_of_birth,
               cvr.default_visitor_label,
               cvr.visit_reason_code,
               cvr.visit_reason_description,
               b.company_code,
               b.checked_in_date_time checked_in_date_time,
               b.leader_ind,
               b.site_code,
               b.nda_accepted_date_time,
               b.printed_date_time printed_date_time,
               b.virtual_badge_sent_date_time virtual_badge_sent_date_time,
               b.collection_point_code,
               b.arrived_collection_point,
               b.checked_in_source,
               ca_visit_pak.get_checkin_source_description(b.checked_in_source) checked_in_source_description,
               b.id_check_date_time,
               allowed_cp.collection_point_description,
               nvl2(b.checked_in_date_time, nvl(arrived_acp.collection_point_description, nvl(b.arrived_collection_point, allowed_cp.collection_point_description)), '') arrived_cp_description,
               allowed_cp.check_id_ind,
               su.username collected_by,
               pi.title hostTitle,
               pi.forename hostForename,
               pi.surname hostSurname,
               pi.known_as knownAs,
               pi.allowed_vip_ind,
               substr(pi.email_address, 0, instr(pi.email_address, '@') - 1 ) hostUsername,
               nvl(z_visitor.zone_code, allowed_cp.zone_code) zone_code,
               nvl(z_visitor.zone_description, allowed_cp.zone_description) zone_description,
               trim (pi.forename || ' ' || pi.surname ) host,
               ptc.person_type_description hostType,
               pi.person_code hostCode,
               pi.person_code || '-' || pi.person_type hostCodeType,
               pi.hr_code,
               d.department_description hostDepartment,
               d.department_code hostDepartmentCode,
               pi.email_address hostEmail,
               trim(pi.country_code || pi.mobile_phone_number) hostMobile,
               ' - ' || allowed_cp.collection_point_description || ' - Visit ID ' || b.group_id group_info,
               b.comments,
               c.company_name companyName,
               spt.title_description hostTitleDesc,
               allowed_cp.timezone time_zone_description,
               b.event_id,
               se.event_description ||' '|| initcap(lower(to_char(se.start_date,'(Mon DDth)'))) event_description,
               se.capacity,
               se.capacity_criteria,
               ca_utility_pak.date_to_iso_zulu_string(se.start_date) event_start_date,
               ca_utility_pak.date_to_iso_zulu_string(se.end_date) event_end_date,
               b.conf_text_1,
               b.conf_combo_1,
               b.conf_text_2,
               b.conf_combo_2,
               b.conf_text_3,
               b.conf_combo_3,
               b.conf_text_4,
               b.conf_combo_4,
               b.conf_text_5,
               b.conf_combo_5,
               b.conf_text_6,
               b.shared_qr_cc_hosts,
               b.watchlist_ind,
               b.watchlist_approver,
               cahd.alt_hosts,
               cahd.cchost_username,
               cahd.cchost_known_as,
               b.arrive_date_time,
               b.reception_accept_ind,
               b.collected_date_time,
               (select forename || ' ' || surname from ca_person_interface bcpi inner join safe_user bsu on bcpi.person_code = bsu.person_code and bcpi.person_type = bsu.person_type  where bsu.username = b.booker_username) booker,
               b.collecting_badge_number || ca_get_badge_type(b.collecting_badge_number, b.collecting_issue_number) as collecting_badge_number,
               nvl(b.vip_code, 'N') vip,
               b.agenda,
               cvb.badge_number visitor_badge_number,
               b.visitor_type_code,
               b.visitor_type_description,
               nvl(decode(length(b.picture), null, 0, 1),0) haspicture,
               nvl(decode(length(b.signature), null, 0, 1),0) hassignature,
               cvd.vetting_ind,
               cvd.vetting_reviewed_date_time,
               (
                  select tab_to_string(cast(collect(to_char(ch.host_person_code || '-' || ch.host_person_type)) as t_varchar2_tab), ', ')
                  from ca_host ch
                  where ch.booking_reference = b.booking_reference
                     and cancellation_date_time is null
                     and primary_ind != 'Y'
               ) cc_host_person_code_type,
               cvd.notif_send_host notif_ind_email_host,
               cvd.notif_send_cchosts notif_ind_email_cchosts,
               cvd.notif_send_visitor notif_ind_email_visitor,
               cvd.notif_send_sms_host notif_ind_sms_host,
               cvd.notif_send_sms_cchosts notif_ind_sms_cchosts,
               cvd.notif_send_sms_visitor notif_ind_sms_visitor,
               b.car_parking_booking_id,
               cvd.nda_signature_bypass_username,
               cvd.id_verification_status,
               b.visitor_type_workflow,
               (select ca_get_kiosk_local_setting(b.collection_point_code, 'showScannerPanel') from dual) as showScannerPanel
            from
               ca_booked_person_filter b join ca_host h on b.booking_reference = h.booking_reference
                  and b.rejected_date_time is null 
                  and b.approved_date_time is not null
                  and h.primary_ind = 'Y'
               left join ca_visitor_detail cvd on cvd.booking_reference = b.booking_reference
               join ca_person_interface pi on h.host_person_code = pi.person_code and h.host_person_type = pi.person_type
               left outer join ca_company c on c.company_code = b.company_code
               left outer join ca_department d on pi.department_code = d.department_code
               left outer join ca_person_type_control ptc on pi.person_type = ptc.person_type
               left outer join safe_person_title spt on pi.title = spt.title_code
               left outer join safe_event se on b.event_id = se.event_id
               join safe_kiosk_monitor skm on b.collection_point_code = skm.terminal_code
               join allowed_cp on b.collection_point_code = allowed_cp.collection_point_code
               left join allowed_cp arrived_acp on b.arrived_collection_point = arrived_acp.collection_point_code
               left outer join safe_meal sm on b.meal_code = sm.meal_code
               left outer join ca_language cl on b.language_code = cl.language_code
               left join safe_kiosk_languages_view skl on skl.language_code = b.communication_language_code
               left outer join safe_country sc on b.country_code  = sc.iso2
               left outer join ca_nationality cn on b.nationality_code = cn.nationality_code
               left join ca_visit_reason cvr on b.reason_code = cvr.visit_reason_code
               left join safe_user su on b.collecting_person_code = su.person_code and b.collecting_person_type = su.person_type
               left join ca_alternative_hosts_data cahd on b.booking_reference = cahd.booking_reference
               left join ca_visitor_badge cvb on cvb.booking_reference = b.booking_reference
               left join ca_person_interface cpi on cpi.booking_reference = b.booking_reference
               left join ca_badge cb on cb.person_code = cpi.person_code and cb.person_type = cpi.person_type and cb.status_ind = 'V'
               left join ca_zone z_visitor on cpi.zone_code = z_visitor.zone_code
               left join safe_checked_in_source scis on b.checked_in_source = scis.checked_in_source_code
            where
               lower (
                                                   b.collection_point_code          || ' ' ||
                                                   b.unnamed_visitors               || ' ' ||
                                                   b.site_code                      || ' ' ||
                                                   b.printed_badge_number           || ' ' ||
                                                   case when safe_get_setting_or_null('enable_visitor_badge_manager') = 'Y' then cvb.badge_number else case when safe_get_setting_or_null('rfid_no_access') = 'Y' then to_char(b.access_badge_number) else to_char(cb.badge_number) end end || ' ' ||
                                                   b.group_id                       || ' ' ||
                                                   b.forename                       || ' ' || 
                                                   b.surname                        || ' ' ||
                                                   b.forename                       || ' ' ||
                                                   b.middle_name                    || ' ' ||
                                                   b.surname                        || ' ' ||
                                                   b.visitor_type_description       || ' ' ||
                                                   pi.forename                      || ' ' ||  
                                                   pi.surname                       || ' ' ||
                                                   pi.forename                      || ' ' ||  
                                                   pi.known_as                      || ' ' ||
                                                   pi.hr_code                       || ' ' ||
                                                   ca_visit_pak.get_checkin_source_description(b.checked_in_source) || ' ' ||
                                                   cahd.alt_hosts                   || ' ' ||
                                                   cahd.cchost_username             || ' ' ||
                                                   cahd.cchost_known_as             || ' ' ||
                                                   substr(pi.email_address, 0, instr(pi.email_address, '@') - 1)  || ' ' ||
                                                   c.company_name                   || ' ' ||
                                                   allowed_cp.collection_point_description || ' ' ||
                                                   b.mobile_phone_number            || ' ' ||
                                                   sm.meal_description              || ' ' ||
                                                   sc.country_name                  || ' ' ||
                                                   cl.language_description          || ' ' ||
                                                   skl.language_description         || ' ' ||
                                                   cn.nationality_description       || ' ' ||
                                                   b.vehicle_reg                    || ' ' ||
                                                   allowed_cp.timezone              || ' ' ||
                                                   nvl(z_visitor.zone_description, allowed_cp.zone_description) || ' ' ||
                                                   cvr.visit_reason_description     || ' ' ||
                                                   to_char(b.date_of_birth, :DateTimeFormat) ||' '||
                                                   se.event_description ||' '|| initcap(lower(to_char(se.start_date,'(Mon DDth)'))) || ' '||
                                                   to_char(b.due_date_time, :DateTimeFormat)                      ||' '||
                                                   to_char(b.end_date_time, :DateTimeFormat)                      ||' '||
                                                   to_char(b.checked_in_date_time, :DateTimeFormat)               ||' '||
                                                   to_char(b.printed_date_time, :DateTimeFormat)                  ||' '||
                                                   to_char(b.virtual_badge_sent_date_time, :DateTimeFormat)       ||' '||
                                                   to_char(b.id_check_date_time, :DateTimeFormat)                 ||' '||
                                                   safe_get_encoded_reference(b.booking_reference) ||' '||
                                                   b.conf_text_1                     ||' '||
                                                   b.conf_combo_1                    ||' '||
                                                   b.conf_text_2                     ||' '||
                                                   b.conf_combo_2                    ||' '||
                                                   b.conf_text_3                     ||' '||
                                                   b.conf_combo_3                    ||' '||
                                                   b.conf_text_4                     ||' '||
                                                   b.conf_combo_4                    ||' '||
                                                   b.conf_text_5                     ||' '||
                                                   b.conf_combo_5                    ||' '||
                                                   b.shared_qr_cc_hosts              ||' '||
                                                   b.collected_date_time             ||' '||
                                                   cvd.nda_signature_bypass_username ||' '||
                                                   (select forename || ' ' || surname from ca_person_interface bcpi inner join safe_user bsu on bcpi.person_code = bsu.person_code and bcpi.person_type = bsu.person_type  where bsu.username = b.booker_username)
                  ) like ('%' || lower(:query) || '%')    
            order by
               case when upper(:dir) = 'ASC' then decode( :sort,
                                                'due_date_time',                 ca_utility_pak.date_to_iso_zulu_string(b.due_date_time),
                                                'end_date_time',                 ca_utility_pak.date_to_iso_zulu_string(b.end_date_time),
                                                'id_check_date_time',            ca_utility_pak.date_to_iso_zulu_string(b.id_check_date_time),
                                                'collection_point_description',  lower(allowed_cp.collection_point_description),
                                                'public_reference',              lower(safe_get_encoded_reference(b.booking_reference)),
                                                'host',                          lower(trim (pi.forename || ' ' || pi.surname)),  
                                                'group_id',                      lower(b.group_id),
                                                'title',                         lower(pi.title),
                                                'unnamed_visitors',              lower(unnamed_visitors),
                                                'forename',                      lower(b.forename),
                                                'middle_name',                   lower(b.middle_name),                   
                                                'surname',                       lower(b.surname),
                                                'date_of_birth',                 ca_utility_pak.date_to_iso_zulu_string(b.date_of_birth),   
                                                'knownas',                       lower(pi.known_as),
                                                'hr_code',                       lower(pi.hr_code),
                                                'hostusername',                  lower(substr(pi.email_address, 0, instr(pi.email_address, '@') - 1)),
                                                'alt_hosts',                     lower(cahd.alt_hosts),
                                                'cchost_username',               lower(cahd.cchost_username),
                                                'cchost_known_as',               lower(cahd.cchost_known_as),
                                                'leader_ind',                    lower(b.leader_ind),             
                                                'checked_in_date_time',          b.checked_in_date_time, 
                                                'printed_date_time',             b.printed_date_time,
                                                'virtual_badge_sent_date_time',  b.virtual_badge_sent_date_time,
                                                'arrive_date_time',              b.arrive_date_time,   
                                                'companyname',                   lower(c.company_name),
                                                'mobile',                        b.mobile_phone_number,
                                                'meal',                          lower(sm.meal_description),
                                                'checked_in_source_description', lower(ca_visit_pak.get_checkin_source_description(b.checked_in_source)),
                                                'country',                       lower(sc.country_name),
                                                'language',                      lower(cl.language_description),
                                                'communication_language',        lower(skl.language_description),
                                                'nationality',                   lower(cn.nationality_description),
                                                'department_code',               lower(d.department_code),
                                                'department_description',        lower(d.department_description),
                                                'vehicle_reg',                   lower(b.vehicle_reg),
                                                'time_zone_description',         lower(allowed_cp.timezone),
                                                'zone',                          lower(allowed_cp.zone_description),
                                                'visit_reason_description',      lower(cvr.visit_reason_description),
                                                'event_description',             lower((se.event_description) ||' '|| initcap(lower(to_char(se.start_date,'(Mon DDth)')))),
                                                'collected_date_time',           ca_utility_pak.date_to_iso_zulu_string(b.collected_date_time),
                                                'valid_badge_number',            decode(safe_get_setting_or_null('enable_visitor_badge_manager'),'Y', cvb.badge_number, decode(safe_get_setting_or_null('rfid_no_access'),'Y', b.access_badge_number, cb.badge_number)),
                                                'visitor_type_description',      lower(b.visitor_type_description),
                                                'conf_text_1',                    lower(b.conf_text_1),
                                                'conf_combo_1',                   lower(b.conf_combo_1),
                                                'conf_text_2',                    lower(b.conf_text_2),
                                                'conf_combo_2',                   lower(b.conf_combo_2),
                                                'conf_text_3',                    lower(b.conf_text_3),
                                                'conf_combo_3',                   lower(b.conf_combo_3),
                                                'conf_text_4',                    lower(b.conf_text_4),
                                                'conf_combo_4',                   lower(b.conf_combo_4),
                                                'conf_text_5',                    lower(b.conf_text_5),
                                                'conf_combo_5',                   lower(b.conf_combo_5),
                                                'shared_qr_cc_hosts',             lower(b.shared_qr_cc_hosts),
                                                'nda_signature_bypass_username',  cvd.nda_signature_bypass_username,
                                                ca_utility_pak.date_to_iso_zulu_string(b.due_date_time)
               )end asc,
               case when upper(:dir) = 'DESC' then decode( :sort,
                                                'due_date_time',                  ca_utility_pak.date_to_iso_zulu_string(b.due_date_time),
                                                'end_date_time',                  ca_utility_pak.date_to_iso_zulu_string(b.end_date_time),
                                                'id_check_date_time',             ca_utility_pak.date_to_iso_zulu_string(b.id_check_date_time),
                                                'collection_point_description',   lower(allowed_cp.collection_point_description),
                                                'public_reference',               lower(safe_get_encoded_reference(b.booking_reference)),
                                                'host',                           lower(trim (pi.forename || ' ' || pi.surname)),  
                                                'group_id',                       lower(b.group_id),  
                                                'title',                          lower(pi.title),                                                
                                                'unnamed_visitors',               lower(unnamed_visitors),
                                                'forename',                       lower(b.forename),                 
                                                'middle_name',                    lower(b.middle_name),                   
                                                'surname',                        lower(b.surname),
                                                'date_of_birth',                  ca_utility_pak.date_to_iso_zulu_string(b.date_of_birth),    
                                                'knownas',                        lower(pi.known_as),
                                                'hr_code',                        lower(pi.hr_code),
                                                'hostusername',                   lower(substr(pi.email_address, 0, instr(pi.email_address, '@') - 1)),
                                                'alt_hosts',                      lower(cahd.alt_hosts),
                                                'cchost_username',                lower(cahd.cchost_username),
                                                'cchost_known_as',                lower(cahd.cchost_known_as),
                                                'leader_ind',                     lower(b.leader_ind),             
                                                'checked_in_date_time',           b.checked_in_date_time, 
                                                'printed_date_time',              b.printed_date_time,  
                                                'virtual_badge_sent_date_time',   b.virtual_badge_sent_date_time,  
                                                'arrive_date_time',               b.arrive_date_time,
                                                'companyname',                    lower(c.company_name), 
                                                'mobile',                         b.mobile_phone_number,
                                                'meal',                           lower(sm.meal_description),
                                                'checked_in_source_description',  lower(ca_visit_pak.get_checkin_source_description(b.checked_in_source)),
                                                'country',                        lower(sc.country_name),
                                                'language',                       lower(cl.language_description),
                                                'communication_language',         lower(skl.language_description),
                                                'nationality',                    lower(cn.nationality_description),
                                                'department_code',                lower(d.department_code),
                                                'department_description',         lower(d.department_description),
                                                'vehicle_reg',                    lower(b.vehicle_reg),
                                                'time_zone_description',          lower(allowed_cp.timezone),
                                                'zone',                           lower(allowed_cp.zone_description),
                                                'visit_reason_description',       lower(cvr.visit_reason_description),
                                                'event_description',              lower((se.event_description) ||' '|| initcap(lower(to_char(se.start_date,'(Mon DDth)')))),
                                                'collected_date_time',            ca_utility_pak.date_to_iso_zulu_string(b.collected_date_time),
                                                'valid_badge_number',             decode(safe_get_setting_or_null('enable_visitor_badge_manager'),'Y', cvb.badge_number, decode(safe_get_setting_or_null('rfid_no_access'),'Y', b.access_badge_number, cb.badge_number)),
                                                'visitor_type_description',      lower(b.visitor_type_description),
                                                'conf_text_1',                    lower(b.conf_text_1),
                                                'conf_combo_1',                   lower(b.conf_combo_1),
                                                'conf_text_2',                    lower(b.conf_text_2),
                                                'conf_combo_2',                   lower(b.conf_combo_2),
                                                'conf_text_3',                    lower(b.conf_text_3),
                                                'conf_combo_3',                   lower(b.conf_combo_3),
                                                'conf_text_4',                    lower(b.conf_text_4),
                                                'conf_combo_4',                   lower(b.conf_combo_4),
                                                'conf_text_5',                    lower(b.conf_text_5),
                                                'conf_combo_5',                   lower(b.conf_combo_5),
                                                'shared_qr_cc_hosts',             lower(b.shared_qr_cc_hosts),
                                                'nda_signature_bypass_username',  cvd.nda_signature_bypass_username,
                                                ca_utility_pak.date_to_iso_zulu_string(b.due_date_time)
               )end desc,
               lower(group_id), lower(b.leader_ind) desc, lower(b.surname) asc, lower(b.forename) asc
         ) iq
      ) aq2
   ) aq2t 
      left join ca_person_interface cpi on cpi.booking_reference = aq2t.booking_reference
      left join ca_person_status cps on cps.person_code = cpi.person_code and cps.person_type = cpi.person_type
      left join access_groups ag on ag.person_code = cpi.person_code and ag.person_type = cpi.person_type
      left join ca_department d_visitor on cpi.department_code = d_visitor.department_code
    where
       aq2t.rnum > :s and aq2t.rnum <= :s+:lim
       and safe_request_permissions_pak.check_permission_sql (
       :Uidtoken, 
       '(visitoractionmenu)', 
       'visitorAction', 
       'GET' 
      ) = 'Y'
) paged
order by
   case when upper(:dir) = 'ASC' then decode( :sort,
                        'due_date_time',                 due_date_time,
                        'end_date_time',                 end_date_time,
                        'date_of_birth',                 date_of_birth,
                        'id_check_date_time',            id_check_date_time,
                        'collection_point_description',  lower(collection_point_description),
                        'public_reference',              lower(booking_reference),
                        'host' ,                         lower(trim (hostforename || ' ' || hostsurname)),
                        'knownas' ,                      lower(knownas),
                        'hr_code',                       lower(hr_code),
                        'hostusername',                  lower(hostusername),
                        'alt_hosts',                     lower(alt_hosts),
                        'cchost_username',               lower(cchost_username),
                        'cchost_known_as',               lower(cchost_known_as),
                        'group_id',                      lower(group_id),  
                        'title',                         lower(title),      
                        'forename',                      lower(forename),
                        'unnamed_visitors',              lower(unnamed_visitors),
                        'middle_name',                   lower(middle_name),
                        'surname',                       lower(surname),        
                        'leader_ind',                    lower(leader_ind),
                        'checked_in_date_time',          checked_in_date_time,  
                        'printed_date_time',             printed_date_time,
                        'virtual_badge_sent_date_time',  virtual_badge_sent_date_time,
                        'arrive_date_time',              arrive_date_time,
                        'companyname',                   lower(companyname),
                        'mobile',                        mobile,
                        'meal',                          lower(meal),
                        'checked_in_source_description', lower(checked_in_source_description),
                        'country',                       lower(country),
                        'language',                      lower(language),
                        'communication_language',        lower(communication_language),
                        'nationality',                   lower(nationality),
                        'department_code',               lower(department_code),
                        'department_description',        lower(department),
                        'zone',                          lower(zone),
                        'vehicle_reg',                   lower(vehicle_reg), 
                        'time_zone_description',         lower(time_zone_description),                        
                        'visit_reason_description',      lower(visit_reason_description),
                        'event_description',             lower(event_description),    
                        'accessgroupcombo',              lower(accessgroupcombo),
                        'collected_date_time',           collected_date_time,
                        'booker',                        lower(booker),
                        'assets_ind',                    assets_ind,
                        'vip',                           lower(vip),
                        'valid_badge_number',            valid_badge_number,
                        'visitor_type_description',      lower(visitor_type_description),
                        'conf_text_1',                    lower(conf_text_1),
                        'conf_combo_1',                   lower(conf_combo_1),
                        'conf_text_2',                    lower(conf_text_2),
                        'conf_combo_2',                   lower(conf_combo_2),
                        'conf_text_3',                    lower(conf_text_3),
                        'conf_combo_3',                   lower(conf_combo_3),
                        'conf_text_4',                    lower(conf_text_4),
                        'conf_combo_4',                   lower(conf_combo_4),
                        'conf_text_5',                    lower(conf_text_5),
                        'conf_combo_5',                   lower(conf_combo_5),
                        'shared_qr_cc_hosts',             lower(shared_qr_cc_hosts),
                        'visitor_uploaded_doc',           visitor_uploaded_doc,
                        'nda_signature_bypass_username',  nda_signature_bypass_username,
                        due_date_time
   )end asc,
   case when upper(:dir) = 'DESC' then decode( :sort,
                        'due_date_time',                 due_date_time,
                        'end_date_time',                 end_date_time,
                        'date_of_birth',                 date_of_birth,
                        'id_check_date_time',            id_check_date_time,
                        'collection_point_description',  lower(collection_point_description),
                        'public_reference',              lower(booking_reference),
                        'host' ,                         lower(trim (hostforename || ' ' || hostsurname)),
                        'knownas' ,                      lower(knownas),
                        'hr_code',                       lower(hr_code),
                        'hostusername',                  lower(hostusername),
                        'alt_hosts',                     lower(alt_hosts),
                        'cchost_username',               lower(cchost_username),
                        'cchost_known_as',               lower(cchost_known_as),
                        'title',                         lower(title),
                        'group_id',                      lower(group_id),
                        'unnamed_visitors',              lower(unnamed_visitors),
                        'forename',                      lower(forename),
                        'middle_name',                   lower(middle_name),
                        'surname',                       lower(surname),        
                        'leader_ind',                    lower(leader_ind),
                        'checked_in_date_time',          checked_in_date_time,
                        'printed_date_time',             printed_date_time,
                        'virtual_badge_sent_date_time',  virtual_badge_sent_date_time,
                        'arrive_date_time',              arrive_date_time,
                        'companyname',                   lower(companyname),
                        'mobile',                        mobile,
                        'meal',                          lower(meal),
                        'checked_in_source_description', lower(checked_in_source_description),
                        'country',                       lower(country),
                        'language',                      lower(language),
                        'communication_language',        lower(communication_language),
                        'nationality',                   lower(nationality),
                        'department_code',               lower(department_code),
                        'department_description',        lower(department),
                        'zone',                          lower(zone),
                        'vehicle_reg',                   lower(vehicle_reg),
                        'time_zone_description',         lower(time_zone_description),
                        'visit_reason_description',      lower(visit_reason_description),
                        'event_description',             lower(event_description),      
                        'accessgroupcombo',              lower(accessgroupcombo),
                        'collected_date_time',           collected_date_time,
                        'booker',                        lower(booker),
                        'assets_ind',                    assets_ind,
                        'vip',                           lower(vip),
                        'valid_badge_number',            valid_badge_number,
                        'visitor_type_description',      lower(visitor_type_description),
                        'conf_text_1',                    lower(conf_text_1),
                        'conf_combo_1',                   lower(conf_combo_1),
                        'conf_text_2',                    lower(conf_text_2),
                        'conf_combo_2',                   lower(conf_combo_2),
                        'conf_text_3',                    lower(conf_text_3),
                        'conf_combo_3',                   lower(conf_combo_3),
                        'conf_text_4',                    lower(conf_text_4),
                        'conf_combo_4',                   lower(conf_combo_4),
                        'conf_text_5',                    lower(conf_text_5),
                        'conf_combo_5',                   lower(conf_combo_5),
                        'shared_qr_cc_hosts',             lower(shared_qr_cc_hosts),
                        'visitor_uploaded_doc',           visitor_uploaded_doc,
                        'nda_signature_bypass_username',  nda_signature_bypass_username,
                        due_date_time
   )end desc,
lower(group_id), lower(leader_ind) desc, lower(surname) asc, lower(forename) asc]]></sql>
		<connection><![CDATA[Trunk]]></connection>
		<timestamp><![CDATA[1720007486158]]></timestamp>
		<type><![CDATA[SQL]]></type>
		<executed><![CDATA[1]]></executed>
		<execTime><![CDATA[1.408]]></execTime>
	</historyItem>
</history>
