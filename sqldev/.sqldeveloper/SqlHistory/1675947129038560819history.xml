<?xml version='1.0'  encoding='UTF-8' ?>
<history>
	<historyItem>
		<sql><![CDATA[with find_zone_code as (
   select zone_code from (
       select zone_code from ca_allowed_cp
       union all
       select sclv.zone_code
       from ca_user_role_permission curp
               inner join safe_cp_location_view sclv on curp.reference_code = sclv.site_code
       where curp.reference_type = 'SE'
    ) group by zone_code
)
select iq.acode,
   iq.adescription,
   iq.adescription2,
   iq.title,
   iq.forename,
   iq.surname,
   iq.assembly_point_code,
   iq.department,
   iq.location,
   iq.email,
   iq.ldap,
   iq.knownas,
   iq.hasphoto,
   iq.score,
   (select setting_value from safe_system_options where setting_name = 'quick_register_show_host_known_as') show_known_as,
   (select setting_value from safe_system_options where setting_name = 'quick_register_show_host_zone') show_zone,
   (select setting_value from safe_system_options where setting_name = 'quick_register_show_host_department') show_department,
   iq.notification_email_ind,
   iq.notification_sms_ind
from
(
   select
      dd.acode,
      dd.adescription,
      dd.adescription2,
      dd.title,
      dd.forename,
      dd.surname,
      dd.assembly_point_code,
      dd.department,
      dd.location,
      dd.email,
      dd.ldap,
      dd.knownas,
      dd.hasphoto,
      dd.notification_email_ind,
      dd.notification_sms_ind,
      dd.score score from
      (
      select * from
         (
            select
               pi.aCode,
               pi.adescription,
               pi.adescription2,
               pi.title,
               pi.forename,
               pi.surname,
               pi.assembly_point_code,
               pi.department,
               pi.zone_description location,
               pi.email,
               pi.ldap,
               pi.knownas,
               pi.hasphoto,
               pi.notification_email_ind,
               pi.notification_sms_ind,
               utl_match.jaro_winkler_similarity(pi.forename || pi.surname, :fuzz) score
         from
             ca_active_host_location_person pi
         where
            ((pi.person_type in(
               select surrpt.reference_code
               from ca_user_role_permission surrpt
               where surrpt.reference_type = 'PNTP'
                 and surrpt.user_role_name = safe_get_user_role(:Uidtoken)
            )
               and pi.zone_code in
                   (
                      select fzc.zone_code
                      from find_zone_code fzc
                   )
               and pi.department_code in
                   (
                      select surrd.reference_code
                      from ca_user_role_permission surrd
                      where surrd.reference_type = 'DT'
                        and surrd.user_role_name = safe_get_user_role(:Uidtoken)
                   ) and safe_get_setting_or_null('qr_host_permission_check') = 'Y') or safe_get_setting_or_null('qr_host_permission_check') = 'N')
               and 
                  (
                     contains(pi.forename, 'fuzzy( '|| :forename ||', 80), 1') > 0 
                     or
                     contains(pi.surname, 'fuzzy( '|| :surname ||', 80), 1') > 0
                  )
           and safe_request_permissions_pak.check_permission_sql (
                     :Uidtoken,
                     '(quickregistermenu)(guestDashboard)(visitoractionmenu)',
                     'quickHostCtx',
                     'GET'
                  ) = 'Y'
      ) union (
         select
            pi.aCode,
            pi.adescription,
            pi.adescription2,
            pi.title,
            pi.forename,
            pi.surname,
            pi.assembly_point_code,
            pi.department,
            pi.zone_description location,
            pi.email,
            pi.ldap,
            pi.knownas,
            pi.hasphoto,
            pi.notification_email_ind,
            pi.notification_sms_ind,
            utl_match.jaro_winkler_similarity(pi.email_lower, :fuzz) score
         from
             ca_active_host_location_facade pi
         where
            ((pi.person_type in(
               select surrpt.reference_code
               from ca_user_role_permission surrpt
               where surrpt.reference_type = 'PNTP'
                 and surrpt.user_role_name = safe_get_user_role(:Uidtoken)
            )
               and pi.zone_code in
                   (
                      select surrz.reference_code
                      from ca_user_role_permission surrz
                      where surrz.reference_type = 'ZE'
                        and surrz.user_role_name = safe_get_user_role(:Uidtoken)
                   )
               and pi.department_code in
                   (
                      select surrd.reference_code
                      from ca_user_role_permission surrd
                      where surrd.reference_type = 'DT'
                        and surrd.user_role_name = safe_get_user_role(:Uidtoken)
                   ) and safe_get_setting_or_null('qr_host_permission_check') = 'Y') or safe_get_setting_or_null('qr_host_permission_check') = 'N')
           and pi.email_address_lower like lower(  '%'||nvl(:forename, '%') || '%@%')
           and safe_request_permissions_pak.check_permission_sql (
                     :Uidtoken,
                     '(quickregistermenu)(guestDashboard)(visitoractionmenu)',
                     'quickHostCtx',
                     'GET'
                  ) = 'Y'
   )
) dd
group by dd.acode,
dd.adescription,
dd.adescription2,
dd.title,
dd.forename,
dd.surname,
dd.assembly_point_code,
dd.department,
dd.location,
dd.email,
dd.ldap,
dd.knownas,
dd.hasphoto,
dd.notification_email_ind,
dd.notification_sms_ind,
dd.score
order by
   score desc,
   dd.adescription asc,
   dd.department
) iq where rownum < 50]]></sql>
		<connection><![CDATA[DB mastercard UAT]]></connection>
		<timestamp><![CDATA[1716803518510]]></timestamp>
		<type><![CDATA[SQL]]></type>
		<executed><![CDATA[1]]></executed>
		<execTime><![CDATA[1.337]]></execTime>
	</historyItem>
</history>
